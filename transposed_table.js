looker.plugins.visualizations.add({
    // id: "transposed_table",      // id is only necessary for legacy custom visualizations
    // label: "Transposed Table",   // label is only necessary for legacy custom visualizations

    // Choose a color - one of our options
    options: {
        fill_type: {
            type: "string",
            label: "Fill Style",
            display: "select",
            section: "Style",
            values: [{
                "Squeeze": "fitColumns"
            }, {
                "Full Width": "fitDataFill"
            }],
            default: "fitDataFill"
        }
    },

    // Set up the initial state of the visualization
    create: function(element, config) {
        var tabulator_container = document.createElement("div")
        tabulator_container.setAttribute("id", "transposed_table");
        element.appendChild(tabulator_container);
        document.querySelector("head").innerHTML += "<style type='text/css'>html, body, #vis {font-family: Open Sans,Helvetica,Arial,sans-serif; font-size: 14px;}</style>"
        document.querySelector("head").innerHTML += "<link rel='stylesheet' href='https://unpkg.com/tabulator-tables@4.2.1/dist/css/tabulator_site.min.css' type='text/css' media='screen'>";
        document.querySelector("head").innerHTML += "<style type='text/css'>.tabulator .tabulator-footer,.tabulator .tabulator-header{box-shadow:none;text-transform:none;white-space:nowrap;-khtml-user-select:none}.tabulator{position:relative;overflow:hidden;font-size:14px;text-align:left;width:100%;margin:1em 0;box-shadow:none;border-radius:.28571/pxrem;transform:translatez(0)}.tabulator[tabulator-layout=fitDataFill] .tabulator-tableHolder .tabulator-table{min-width:100%}.tabulator.tabulator-block-select{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.tabulator .tabulator-header{width:100%;font-style:none;font-weight:700;-moz-user-select:none;-webkit-user-select:none;-o-user-select:none}.tabulator .tabulator-header,.tabulator .tabulator-header .tabulator-col{position:relative;box-sizing:border-box;overflow:hidden}.tabulator .tabulator-header .tabulator-col{display:inline-block;text-align:left;vertical-align:bottom}.tabulator .tabulator-header .tabulator-col.tabulator-moving{position:absolute;border:1px solid #999;background:#dae1e7;pointer-events:none}.tabulator .tabulator-header .tabulator-col .tabulator-col-content{box-sizing:border-box;position:relative;padding:.92857em .78571em}.tabulator .tabulator-header .tabulator-col .tabulator-col-content .tabulator-col-title{box-sizing:border-box;width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;vertical-align:bottom}.tabulator .tabulator-header .tabulator-col .tabulator-col-content .tabulator-col-title .tabulator-title-editor{box-sizing:border-box;width:100%;border:1px solid #999;padding:1px;background:#fff}.tabulator .tabulator-header .tabulator-col .tabulator-col-content .tabulator-arrow{display:inline-block;position:absolute;top:18px;right:8px;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:6px solid #bbb}.tabulator .tabulator-header .tabulator-col.tabulator-col-group .tabulator-col-group-cols{position:relative;display:-ms-flexbox;display:flex;border-top:1px solid #ddd;overflow:hidden}.tabulator .tabulator-header .tabulator-col.tabulator-col-group .tabulator-col-group-cols .tabulator-col:last-child{margin-right:-1px}.tabulator .tabulator-header .tabulator-col:first-child .tabulator-col-resize-handle.prev{display:none}.tabulator .tabulator-header .tabulator-col.ui-sortable-helper{position:absolute;border:1px solid #ddd}.tabulator .tabulator-header .tabulator-col .tabulator-header-filter{position:relative;box-sizing:border-box;margin-top:2px;width:100%;text-align:center}.tabulator .tabulator-header .tabulator-col .tabulator-header-filter textarea{height:auto!important}.tabulator .tabulator-header .tabulator-col .tabulator-header-filter svg{margin-top:3px}.tabulator .tabulator-header .tabulator-col .tabulator-header-filter input::-ms-clear{width:0;height:0}.tabulator .tabulator-header .tabulator-col.tabulator-sortable .tabulator-col-title{padding-right:25px}.tabulator .tabulator-header .tabulator-col.tabulator-sortable:hover{cursor:pointer}.tabulator .tabulator-header .tabulator-col.tabulator-sortable[aria-sort=none] .tabulator-col-content .tabulator-arrow{border-top:none;border-bottom:6px solid #bbb}.tabulator .tabulator-header .tabulator-col.tabulator-sortable[aria-sort=asc] .tabulator-col-content .tabulator-arrow{border-top:none;border-bottom:6px solid #666}.tabulator .tabulator-header .tabulator-col.tabulator-sortable[aria-sort=desc] .tabulator-col-content .tabulator-arrow{border-top:6px solid #666;border-bottom:none}.tabulator .tabulator-header .tabulator-frozen{display:inline-block;position:absolute;z-index:1}.tabulator .tabulator-header .tabulator-calcs-holder .tabulator-row .tabulator-col-resize-handle,.tabulator .tabulator-header .tabulator-frozen-rows-holder:empty{display:none}.tabulator .tabulator-header .tabulator-frozen.tabulator-frozen-left{border-right:2px solid #ddd}.tabulator .tabulator-header .tabulator-frozen.tabulator-frozen-right{border-left:2px solid #ddd}.tabulator .tabulator-header .tabulator-calcs-holder{box-sizing:border-box;min-width:200%;background:#fff!important;border-top:1px solid #ddd;border-bottom:1px solid #ddd;overflow:hidden}.tabulator .tabulator-header .tabulator-calcs-holder .tabulator-row{background:#fff!important}.tabulator .tabulator-header .tabulator-frozen-rows-holder{min-width:200%}.tabulator .tabulator-tableHolder{position:relative;width:100%;white-space:nowrap;overflow:auto;-webkit-overflow-scrolling:touch}.tabulator .tabulator-tableHolder:focus{outline:0}.tabulator .tabulator-tableHolder .tabulator-placeholder{position:absolute;box-sizing:border-box;display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;top:0;left:0;height:100%;width:100%}.tabulator .tabulator-tableHolder .tabulator-placeholder span{display:inline-block;margin:0 auto;padding:10px;font-weight:700;font-size:20px}.tabulator .tabulator-tableHolder .tabulator-table{position:relative;display:inline-block;white-space:nowrap;overflow:visible}.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.tabulator-calcs{font-weight:700;background:#f2f2f2!important}.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.tabulator-calcs.tabulator-calcs-top{border-bottom:2px solid #ddd}.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.tabulator-calcs.tabulator-calcs-bottom{border-top:2px solid #ddd}.tabulator .tabulator-col-resize-handle{position:absolute;right:0;top:0;bottom:0;width:5px}.tabulator .tabulator-col-resize-handle.prev{left:0;right:auto}.tabulator .tabulator-col-resize-handle:hover{cursor:ew-resize}.tabulator .tabulator-footer .tabulator-page:not(.disabled):hover,.tabulator-row.tabulator-selected:hover{cursor:pointer}.tabulator .tabulator-footer{padding:.78571em;background:#f9fafb;text-align:right;font-style:normal;font-weight:400;-ms-user-select:none;user-select:none;-moz-user-select:none;-webkit-user-select:none;-o-user-select:none}.tabulator .tabulator-footer .tabulator-calcs-holder{box-sizing:border-box;width:calc('100% + 20px');margin:-.78571em -.78571em .78571em;text-align:left;background:#fff!important;border-bottom:1px solid #ddd;border-top:1px solid #ddd;overflow:hidden}.tabulator .tabulator-footer .tabulator-calcs-holder .tabulator-row{font-weight:700;background:#fff!important}.tabulator .tabulator-footer .tabulator-calcs-holder .tabulator-row .tabulator-col-resize-handle{display:none}.tabulator .tabulator-footer .tabulator-calcs-holder:only-child{margin-bottom:-.78571em;border-bottom:none}.tabulator .tabulator-footer .tabulator-pages{margin:0 7px}.tabulator .tabulator-footer .tabulator-page{display:inline-block;margin:0 2px;border:1px solid #aaa;border-radius:3px;padding:2px 5px;background:hsla(0,0%,100%,.2);font-family:inherit;font-weight:inherit;font-size:inherit}.tabulator .tabulator-footer .tabulator-page:disabled{opacity:.5}.tabulator .tablulator-loader{position:absolute;display:-ms-flexbox;display:flex;-ms-flex-align:center;align-items:center;top:0;left:0;z-index:3;height:100%;width:100%;text-align:center}.tabulator .tablulator-loader .tabulator-loader-msg{display:inline-block;margin:0 auto;padding:10px 20px;border-radius:10px;background:#fff;font-weight:700;font-size:16px}.tabulator.padded .tabulator-header .tabulator-col .tabulator-col-content,.tabulator.padded .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell{padding:1em}.tabulator .tablulator-loader .tabulator-loader-msg.tabulator-loading{border:4px solid #333}.tabulator .tablulator-loader .tabulator-loader-msg.tabulator-error{border:4px solid #d00}.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell.positive,.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.positive{box-shadow:inset 0 0 0 #a3c293;background:#fcfff5!important}.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell.positive:hover,.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.positive:hover{background:#f7ffe6!important}.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell.negative,.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.negative{box-shadow:inset 0 0 0 #e0b4b4;background:#fff6f6!important}.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell.negative:hover,.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.negative:hover{background:#ffe7e7!important}.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell.error,.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.error{box-shadow:inset 0 0 0 #e0b4b4;background:#fff6f6!important}.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell.error:hover,.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.error:hover{background:#ffe7e7!important}.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell.warning,.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.warning{box-shadow:inset 0 0 0 #c9ba9b;background:#fffaf3!important}.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell.warning:hover,.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.warning:hover{background:#fff4e4!important}.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell.active,.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.active{background:#e0e0e0!important}.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell.active:hover,.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.active:hover{background:#f7ffe6!important}.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell.active,.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.active,.tabulator .tabulator-tableHolder .tabulator-table .tabulator-row.disabled:hover{pointer-events:none}.tabulator.inverted{background:#333;border:none}.tabulator.inverted .tabulator-tableHolder .tabulator-table .tabulator-row{border:none}.tabulator.inverted .tabulator-footer{background:#fff}.tabulator[class*='single line'] .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell{border-right:none}.tabulator.red{border-top:.2em solid #db2828}.tabulator.orange{border-top:.2em solid #f2711c}.tabulator.yellow{border-top:.2em solid #fbbd08}.tabulator.olive{border-top:.2em solid #b5cc18}.tabulator.green{border-top:.2em solid #21ba45}.tabulator.teal{border-top:.2em solid #00b5ad}.tabulator.blue{border-top:.2em solid #2185d0}.tabulator.violet{border-top:.2em solid #6435c9}.tabulator.purple{border-top:.2em solid #a333c8}.tabulator.pink{border-top:.2em solid #e03997}.tabulator.brown{border-top:.2em solid #a5673f}.tabulator.grey{border-top:.2em solid #767676}.tabulator.black{border-top:.2em solid #1b1c1d}.tabulator.padded .tabulator-header .tabulator-col .tabulator-col-content .tabulator-arrow{top:20px}.tabulator.padded.very .tabulator-header .tabulator-col .tabulator-col-content,.tabulator.padded.very .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell{padding:1.5em}.tabulator.padded.very .tabulator-header .tabulator-col .tabulator-col-content .tabulator-arrow{top:26px}.tabulator.compact .tabulator-header .tabulator-col .tabulator-col-content,.tabulator.compact .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell{padding:.5em .7em}.tabulator.compact .tabulator-header .tabulator-col .tabulator-col-content .tabulator-arrow{top:12px}.tabulator.compact.very .tabulator-header .tabulator-col .tabulator-col-content,.tabulator.compact.very .tabulator-tableHolder .tabulator-table .tabulator-row .tabulator-cell{padding:.4em .6em}.tabulator.compact.very .tabulator-header .tabulator-col .tabulator-col-content .tabulator-arrow{top:10px}.tabulator-row{position:relative;box-sizing:border-box;min-height:22px}.tabulator-row.tabulator-selectable:hover{background:#e0e0e0!important;cursor:pointer}.tabulator-row.tabulator-moving{position:absolute;border-top:1px solid #ddd;border-bottom:1px solid #ddd;pointer-events:none!important;z-index:2}.tabulator-row .tabulator-row-resize-handle{position:absolute;right:0;bottom:0;left:0;height:5px}.tabulator-row .tabulator-row-resize-handle.prev{top:0;bottom:auto}.tabulator-row .tabulator-row-resize-handle:hover{cursor:ns-resize}.tabulator-row .tabulator-frozen{display:inline-block;position:absolute;z-index:1}.tabulator-row .tabulator-frozen.tabulator-frozen-left{border-right:2px solid #ddd}.tabulator-row .tabulator-frozen.tabulator-frozen-right{border-left:2px solid #ddd}.tabulator-row .tabulator-responsive-collapse{box-sizing:border-box;padding:5px;border-top:1px solid #ddd;border-bottom:1px solid #ddd}.tabulator-row .tabulator-responsive-collapse:empty{display:none}.tabulator-row .tabulator-responsive-collapse table{font-size:14px}.tabulator-row .tabulator-responsive-collapse table tr td{position:relative}.tabulator-row .tabulator-responsive-collapse table tr td:first-of-type{padding-right:10px}.tabulator-row .tabulator-cell{display:inline-block;position:relative;box-sizing:border-box;padding:.78571em;vertical-align:middle;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.tabulator-row .tabulator-cell:last-of-type{border-right:none}.tabulator-row .tabulator-cell.tabulator-editing{border:1px solid #1d68cd;padding:0}.tabulator-row .tabulator-cell.tabulator-editing input,.tabulator-row .tabulator-cell.tabulator-editing select{border:1px;background:0 0}.tabulator-row .tabulator-cell.tabulator-validation-fail{border:1px solid #d00}.tabulator-row .tabulator-cell.tabulator-validation-fail input,.tabulator-row .tabulator-cell.tabulator-validation-fail select{border:1px;background:0 0}.tabulator-row .tabulator-cell:first-child .tabulator-col-resize-handle.prev{display:none}.tabulator-row .tabulator-cell.tabulator-row-handle{display:-ms-inline-flexbox;display:inline-flex;-ms-flex-align:center;align-items:center;-moz-user-select:none;-khtml-user-select:none;-webkit-user-select:none;-o-user-select:none}.tabulator-row .tabulator-cell.tabulator-row-handle .tabulator-row-handle-box{width:80%}.tabulator-row .tabulator-cell.tabulator-row-handle .tabulator-row-handle-box .tabulator-row-handle-bar{width:100%;height:3px;margin-top:2px;background:#666}.tabulator-row .tabulator-cell .tabulator-responsive-collapse-toggle{display:-ms-inline-flexbox;display:inline-flex;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center;-moz-user-select:none;-khtml-user-select:none;-webkit-user-select:none;-o-user-select:none;height:15px;width:15px;border-radius:20px;background:#666;font-weight:700;font-size:1.1em}.tabulator-row .tabulator-cell .tabulator-responsive-collapse-toggle:hover{opacity:.7}.tabulator-row .tabulator-cell .tabulator-responsive-collapse-toggle.open .tabulator-responsive-collapse-toggle-close{display:initial}.tabulator-row .tabulator-cell .tabulator-responsive-collapse-toggle .tabulator-responsive-collapse-toggle-close,.tabulator-row .tabulator-cell .tabulator-responsive-collapse-toggle.open .tabulator-responsive-collapse-toggle-open{display:none}.tabulator-row.tabulator-group{box-sizing:border-box;border-bottom:1px solid #999;border-right:1px solid #ddd;border-top:1px solid #999;padding:5px 5px 5px 10px;background:#fafafa;font-weight:700;min-width:100%}.tabulator-row.tabulator-group:hover{cursor:pointer}.tabulator-row.tabulator-group.tabulator-group-visible .tabulator-arrow{margin-right:10px;border-left:6px solid transparent;border-right:6px solid transparent;border-top:6px solid #666;border-bottom:0}.tabulator-row.tabulator-group.tabulator-group-level-1 .tabulator-arrow{margin-left:20px}.tabulator-row.tabulator-group.tabulator-group-level-2 .tabulator-arrow{margin-left:40px}.tabulator-row.tabulator-group.tabulator-group-level-3 .tabulator-arrow{margin-left:60px}.tabulator-row.tabulator-group.tabulator-group-level-4 .tabulator-arrow{margin-left:80px}.tabulator-row.tabulator-group.tabulator-group-level-5 .tabulator-arrow{margin-left:100px}.tabulator-row.tabulator-group .tabulator-arrow{display:inline-block;width:0;height:0;margin-right:16px;border-top:6px solid transparent;border-bottom:6px solid transparent;border-right:0;border-left:6px solid #666;vertical-align:middle}.tabulator-row.tabulator-group span{margin-left:10px}</style>"
    },
    // Render in response to the data or settings changing
    updateAsync: function(data, element, config, queryResponse, details, done) {

        // print data to console for debugging:
        console.log("data", data);
        console.log("config", config);
        console.log("queryResponse", queryResponse);

        // add measures as initial column
        var clmns = [{
            title: "",
            field: "measure",
            sortable: true,
            datanum: -1
        }];

        // get dimension name that we are switching to be column headers
        dimension_name = queryResponse.fields.dimension_like[0].name;

        // loop through values for each column
        for (var i = 0; i < data.length; i++) {
            var values = {
                title: data[i][dimension_name].value,
                field: data[i][dimension_name].value,
                datanum: i,
                sortable: true,
                align: "right" // the actual data columns' data will align right
            };
            clmns.push(values)
        }

        var rws = [];
        measures_with_table_calculations = queryResponse.fields.measure_like.concat(queryResponse.fields.table_calculations)
            // loop through the measures that we need to transpose
        for (var i = 0; i < measures_with_table_calculations.length; i++) {
            measure = measures_with_table_calculations[i];

            // create a row
            var rw = {
                measure: measure.label_short || measure.label
            };

            // for each dimension, set the measure value
            for (j = 1; j < clmns.length; j++) {
                returned_value = data[clmns[j].datanum][measure.name];
                if (returned_value.rendered != null) {
                    rw[clmns[j].field] = returned_value.rendered;
                } else {
                    rw[clmns[j].field] = returned_value.value;
                }
            }

            // add the row to the data
            rws.push(rw);
        }

        // add data to the table
        var tbl = new Tabulator("#transposed_table", {
            tooltips: true,
            layout: config.fill_type || "fitDataFill",
            columns: clmns,
            data: rws,
            movableColumns: true
        });
        done();
    }
});